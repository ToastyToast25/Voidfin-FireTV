name: Store Compliance

on:
  push:
    branches:
      - master
      - release-*
    paths-ignore:
      - '**.md'
      - 'LOGOS/**'
      - 'SCREENSHOTS/**'
      - 'BACKUP-LOGOS/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    paths-ignore:
      - '**.md'
      - 'LOGOS/**'
      - 'SCREENSHOTS/**'
      - 'BACKUP-LOGOS/**'
      - '.gitignore'
      - 'LICENSE'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  store-compliance:
    name: ${{ matrix.store }} Compliance
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - store: Amazon Appstore
            flavor: amazon
            build_flag: IS_AMAZON_BUILD
          - store: Google Play Store
            flavor: googleplay
            build_flag: IS_GOOGLE_PLAY_BUILD
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Android
        uses: ./.github/actions/setup-android

      - name: Build ${{ matrix.flavor }} debug APK
        run: ./gradlew assemble${{ matrix.flavor }}Debug --parallel --build-cache --configuration-cache
        env:
          GRADLE_OPTS: -Xmx4096m -XX:MaxMetaspaceSize=1g

      - name: Verify compliance
        run: |
          APK=$(find app/build/outputs/apk/${{ matrix.flavor }}/debug -name "*.apk" | head -1)

          echo "=== ${{ matrix.store }} Compliance Check ==="
          echo "APK: $APK"
          echo ""

          # Check for REQUEST_INSTALL_PACKAGES permission (should NOT exist)
          echo "Checking for REQUEST_INSTALL_PACKAGES permission..."
          if aapt dump permissions "$APK" | grep -q "REQUEST_INSTALL_PACKAGES"; then
            echo "❌ FAIL: REQUEST_INSTALL_PACKAGES found (violates ${{ matrix.store }} policy)"
            exit 1
          else
            echo "✓ PASS: No REQUEST_INSTALL_PACKAGES permission"
          fi

          # Check for FileProvider (should NOT exist)
          echo "Checking for FileProvider..."
          if aapt dump xmltree "$APK" AndroidManifest.xml | grep -q "FileProvider"; then
            echo "❌ FAIL: FileProvider found (not needed for ${{ matrix.flavor }} build)"
            exit 1
          else
            echo "✓ PASS: No FileProvider"
          fi

          # Verify BuildConfig flags
          echo "Checking BuildConfig flags..."
          if unzip -p "$APK" classes.dex | strings | grep -q "${{ matrix.build_flag }}"; then
            echo "✓ PASS: BuildConfig flags present"
          else
            echo "⚠ WARNING: Could not verify BuildConfig flags"
          fi

          echo ""
          echo "=== ${{ matrix.store }} Compliance: PASSED ==="
