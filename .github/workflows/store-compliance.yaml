name: Store Compliance

on:
  push:
    branches:
      - master
      - release-*
    paths-ignore:
      - '**.md'
      - 'LOGOS/**'
      - 'SCREENSHOTS/**'
      - 'BACKUP-LOGOS/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    paths-ignore:
      - '**.md'
      - 'LOGOS/**'
      - 'SCREENSHOTS/**'
      - 'BACKUP-LOGOS/**'
      - '.gitignore'
      - 'LICENSE'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  store-compliance:
    name: ${{ matrix.store }} Compliance
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - store: Amazon Appstore
            flavor: amazon
            build_flag: IS_AMAZON_BUILD
          - store: Google Play Store
            flavor: googleplay
            build_flag: IS_GOOGLE_PLAY_BUILD
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Android
        uses: ./.github/actions/setup-android

      - name: Build ${{ matrix.flavor }} debug APK
        run: ./gradlew assemble${{ matrix.flavor }}Debug --parallel --build-cache --configuration-cache
        env:
          GRADLE_OPTS: -Xmx4096m -XX:MaxMetaspaceSize=1g

      - name: Verify compliance
        run: |
          APK=$(find app/build/outputs/apk/${{ matrix.flavor }}/debug -name "*.apk" | head -1)

          echo "=== ${{ matrix.store }} Compliance Check ==="
          echo "APK: $APK"
          echo ""

          # Find aapt2 (newer version, should be available)
          AAPT=$(find "$ANDROID_HOME/build-tools" -name "aapt2" | sort -V | tail -1)
          if [ -z "$AAPT" ]; then
            echo "❌ ERROR: aapt2 not found in Android SDK"
            exit 1
          fi
          echo "Using: $AAPT"
          echo ""

          # Check for REQUEST_INSTALL_PACKAGES permission (should NOT exist)
          echo "Checking for REQUEST_INSTALL_PACKAGES permission..."
          PERMISSIONS=$("$AAPT" dump permissions "$APK" 2>&1)
          if [ $? -ne 0 ]; then
            echo "❌ ERROR: Failed to dump permissions"
            echo "$PERMISSIONS"
            exit 1
          fi

          if echo "$PERMISSIONS" | grep -q "REQUEST_INSTALL_PACKAGES"; then
            echo "❌ FAIL: REQUEST_INSTALL_PACKAGES found (violates ${{ matrix.store }} policy)"
            exit 1
          else
            echo "✓ PASS: No REQUEST_INSTALL_PACKAGES permission"
          fi

          # Check for FileProvider (should NOT exist)
          echo "Checking for FileProvider..."
          MANIFEST=$("$AAPT" dump xmltree "$APK" AndroidManifest.xml 2>&1)
          if [ $? -ne 0 ]; then
            echo "❌ ERROR: Failed to dump manifest"
            echo "$MANIFEST"
            exit 1
          fi

          if echo "$MANIFEST" | grep -q "FileProvider"; then
            echo "❌ FAIL: FileProvider found (not needed for ${{ matrix.flavor }} build)"
            exit 1
          else
            echo "✓ PASS: No FileProvider"
          fi

          # Verify BuildConfig flags
          echo "Checking BuildConfig flags..."
          if unzip -p "$APK" classes.dex | strings | grep -q "${{ matrix.build_flag }}"; then
            echo "✓ PASS: BuildConfig.${{ matrix.build_flag }} present"
          else
            echo "❌ FAIL: Could not find BuildConfig.${{ matrix.build_flag }}"
            exit 1
          fi

          echo ""
          echo "✅ All ${{ matrix.store }} compliance checks passed!"
